{% extends "base.html" %}
{% block title %}Customer Details – Agents SSO Master{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Customer Details: {{ customer.name }}</h1>
    <a href="{{ url_for('manage_customers') }}" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Back to Customers</a>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2 mb-4">
        {% for category, message in messages %}
          <div class="p-3 rounded {{ 'bg-green-100 text-green-800' if category == 'success' else 'bg-red-100 text-red-800' }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Customer Information</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><strong>Customer ID:</strong> {{ customer.code }}</div>
      <div><strong>Name:</strong> {{ customer.name }}</div>
      <div><strong>Email:</strong> {{ customer.email or 'N/A' }}</div>
      <div><strong>Phone:</strong> {{ customer.phone or 'N/A' }}</div>
      <div><strong>PAN:</strong> {{ customer.pan or 'N/A' }}</div>
      <div><strong>GST:</strong> {{ customer.gst or 'N/A' }}</div>
      <div class="md:col-span-2"><strong>Address:</strong> {{ customer.address or 'N/A' }}</div>
      <div class="md:col-span-2">
        <strong>Current Status:</strong> 
        {% if customer.status == 'Pending' %}
          <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm font-semibold">{{ customer.status }}</span>
        {% elif customer.status == 'Awaiting Approval' %}
          <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-semibold">{{ customer.status }}</span>
        {% elif customer.status == 'SSO Setup Pending' %}
          <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm font-semibold">{{ customer.status }}</span>
        {% elif customer.status == 'Final Approval Pending' %}
          <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-sm font-semibold">{{ customer.status }}</span>
        {% elif customer.status == 'Verified' %}
          <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-semibold">{{ customer.status }}</span>
        {% elif customer.status == 'Rejected' %}
          <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm font-semibold">{{ customer.status }}</span>
        {% else %}
          <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-sm">{{ customer.status }}</span>
        {% endif %}
      </div>
      {% if latest_report %}
      <div class="md:col-span-2">
        <strong>Latest Report Status:</strong> {{ latest_report.status }} (Generated: {{ latest_report.generated_date }})
        {% if latest_report.approver_notes %}
          <p class="text-sm text-gray-600 mt-1">Notes: {{ latest_report.approver_notes }}</p>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Actions</h2>
    <div class="flex flex-wrap gap-3">
      {% if session.role == 'admin' %}
        {% if customer.status == 'Pending' %} 
          <form action="{{ url_for('generate_role_report', customer_id=customer.id) }}" method="POST">
            <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">Generate Report</button>
          </form>
        {% elif customer.status == 'SSO Setup Pending' %} 
          <form action="{{ url_for('mark_sso_complete', customer_id=customer.id) }}" method="POST">
            <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">Mark SSO Setup Complete</button>
          </form>
        {% endif %}
        <form action="/delete-customer/{{ customer.id }}" method="POST" onsubmit="return confirm('Delete this customer and all associated certificates and reports?')">
          <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete Customer</button>
        </form>
      {% endif %}
    </div>
  </div>

  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-xl font-semibold mb-4">Associated Certificates</h2>
    {% if certificates %}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for cert in certificates %}
          <div class="bg-gray-50 shadow rounded-lg p-4 border">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">{{ cert.cert_type }}</h3>
            <p><strong>Status:</strong>
              {% if cert.status == 'Active' %}
                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-sm font-semibold">Active</span>
              {% elif cert.status == 'Expired' %}
                <span class="bg-red-100 text-red-700 px-2 py-1 rounded text-sm font-semibold">Expired</span>
              {% elif cert.status == 'Unverified' %}
                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm font-semibold">Unverified</span>
              {% elif cert.status == 'Rejected' %}
                <span class="bg-gray-300 text-gray-800 px-2 py-1 rounded text-sm font-semibold">Rejected</span>
              {% else %}
                <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded text-sm">Unknown</span>
              {% endif %}
            </p>
            <p><strong>Activation:</strong> {{ cert.activation_date }}</p>
            <p><strong>Expiry:</strong> {{ cert.expiration_date }}</p>
            <p class="mt-2">
              <strong>Verified:</strong> 
              {% if cert.verified %}
                <span class="text-green-700 font-medium">Yes ✅</span>
              {% else %}
                <span class="text-red-700 font-medium">No ❌</span>
              {% endif %}
            </p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-600">No certificates associated with this customer.</p>
    {% endif %}
  </div>

</div>
{% endblock %}
